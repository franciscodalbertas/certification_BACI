---
title: "matching"
author: "Francisco d'Albertas"
date: "19/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE,warning = FALSE)

################################################################################
#### pacotes
################################################################################

library(sf)
library(dplyr)
library(tidyr)
library(plm)
require(MatchIt)
require(optmatch)
library(ggpubr)
library(scales)
####

```


## Pareando as propriedades certificadas e nao certificadas

```{r include=FALSE}

# Os dados estão todos no seguinte caminho (substituir por link do drive!):

# link: https://drive.google.com/drive/folders/1J4SWKgCICBbMZX2WeANjvuIg_jz3Mu_l?usp=sharing

# pasta raiz
p <- dirname(getwd())


```


Data dos contratos de certificação:

```{r echo=FALSE}

# caminho dos shapes (tb vale criar um link no drive depois!)

p_cert <- file.path(p,"dados_Imaflora_RA_clean")

# esses dados nao contem as propriedades adicionais da cooxupe! o n real é de
# 537 propriedades, mas o inicio da certificação é o mesmo
certificadas <- read.csv(file.path(p_cert,"propriedades_certificadas.csv"),
                         row.names = 1)

summary(as.Date(certificadas$Date.Issued))
rm(certificadas)

```

A data mais antiga é 2009, logo consideramos os 5 anos anteriores para o matching.

Variáveis do pareamento:

- desmatamento acumulado entre 2004 e 2009;
- presença de RL;
- bioma;
- regeneração acumulada (ainda nao decidimos);
- área da propriedade (em módulos fiscais o ajuste ficou pior);
- declividade média;
- proporção de pastagem;
- proporção de vegetação nativa;

## Modelos


Distribuicao de propriedades certificadas entre MA e CE:

```{r echo=FALSE}

df <- read.csv("data_for_matching.csv")
names(df)[8] <- "biome"
summary(as.factor(df$biome[df$treatment=="certified"]))

```



```{r include=FALSE}
# Aqui gera uma matrix aleatória que a gente pode repetir
set.seed(1)
rand<-sample(nrow(df))
# #rand
data.rand1<-df[rand, ]
#head(data.rand1)
# 
data.rand1$treatment <- as.factor(data.rand1$treatment)
data.rand1$treatment <- relevel(data.rand1$treatment, ref = "non certified")

```


```{r}

formula <- treatment ~ desm_ac + LR_bin + propAPP +area_im + prop_veg_09  + prop_past_09+ mean_slope + reg_ac

```


Após testar diferentes metofologias, verificamos que **Nearest Neighbour** foi a que gerou pareamento mais satisfatório.


```{r echo=FALSE}

df_ma <- subset(data.rand1,subset = biome=="MATA ATLÂNTICA")
df_ce <- subset(data.rand1,subset = biome=="CERRADO")


```


Distribuicao das variaveis

```{r echo=FALSE}

dfplot <- df

dfplot$desm_ac <- dfplot$desm_ac+10^-5
dfplot$reg_ac <- dfplot$reg_ac+10^-5

ggdensity(dfplot,x = "area_im",color = "treatment")+facet_grid("biome")+scale_x_log10()
ggdensity(dfplot,x = "desm_ac",color = "treatment")+facet_grid("biome")+scale_x_log10(labels = comma)
ggdensity(dfplot,x = "reg_ac",color = "treatment")+facet_grid("biome")+scale_x_log10(labels = comma)
ggdensity(dfplot,x = "propAPP",color = "treatment")+facet_grid("biome")
ggdensity(dfplot,x = "prop_veg_09",color = "treatment")+facet_grid("biome")
ggdensity(dfplot,x = "prop_past_09",color = "treatment")+facet_grid("biome")
ggdensity(dfplot,x = "mean_slope",color = "treatment")+facet_grid("biome")

rl <- as.data.frame(table(dfplot$LR_bin,dfplot$treatment,dfplot$biome))

names(rl)[1] <- "LR bin"

rl$prop <- NA
rl$prop[rl$Var2=="certified"&rl$Var3=="CERRADO"] <- rl$Freq[rl$Var2=="certified"&rl$Var3=="CERRADO"]/sum(rl$Freq[rl$Var2=="certified"&rl$Var3=="CERRADO"])

rl$prop[rl$Var2=="non certified"&rl$Var3=="CERRADO"] <- rl$Freq[rl$Var2=="non certified"&rl$Var3=="CERRADO"]/sum(rl$Freq[rl$Var2=="non certified"&rl$Var3=="CERRADO"])


rl$prop[rl$Var2=="certified"&rl$Var3=="MATA ATLÂNTICA"] <- rl$Freq[rl$Var2=="certified"&rl$Var3=="MATA ATLÂNTICA"]/sum(rl$Freq[rl$Var2=="certified"&rl$Var3=="MATA ATLÂNTICA"])

rl$prop[rl$Var2=="non certified"&rl$Var3=="MATA ATLÂNTICA"] <- rl$Freq[rl$Var2=="non certified"&rl$Var3=="MATA ATLÂNTICA"]/sum(rl$Freq[rl$Var2=="non certified"&rl$Var3=="MATA ATLÂNTICA"])


ggbarplot(rl,fill = "LR bin",y="prop",x = "Var2")+facet_grid("Var3")

```

### Modelo para a mata atlântica:




```{r}

nn_ma <-matchit(formula, data=df_ma, method="nearest", ratio=4, caliper = 0.2,replace = T)
 
summary(nn_ma, standardize = TRUE)

```


### Modelo para o cerrado:

```{r echo=FALSE}

nn_ce <-matchit(formula, data=df_ce, method="nearest", ratio=4, caliper = 0.25,replace = T)
 
summary(nn_ce, standardize = TRUE)

```

### Analisando ajuste dos modelos

#### Mata Atlântica

```{r echo=FALSE}

plot(nn_ma)

plot(nn_ma,"jitter")

plot(nn_ma,"hist")

plot(summary(nn_ma),xlim=c(0,0.7))

```




#### CE

```{r }

plot(nn_ce)

plot(nn_ce,"jitter")

plot(nn_ce,"hist")

plot(summary(nn_ce),xlim=c(0,0.7))

```